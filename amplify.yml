version: 1
backend:
  phases:
    build:
      commands:
        - 'echo "Loading environment variables"'
frontend:
  phases:
    preBuild:
      commands:
        - cd frontend
        - nvm use 18
        - |
          echo "Checking required environment variables..."
          for var in NEXT_PUBLIC_API_URL NEXT_PUBLIC_SUPABASE_URL NEXT_PUBLIC_SUPABASE_ANON_KEY; do
            if [ -z "${!var}" ]; then
              echo "Warning: $var is not set"
            else
              echo "$var is configured"
            fi
          done
        - npm ci
    build:
      commands:
        - 'echo "Setting up environment for build"'
        - >
          if [ "${AWS_BRANCH}" = "master" ]; then
          export NODE_ENV=production;
          echo "Running production build";
          else
          echo "Running development build";
          fi
        - 'echo "Using API URL: ${NEXT_PUBLIC_API_URL:-not_set}"'
        - npm run build
  artifacts:
    baseDirectory: frontend/.next
    files:
      - '**/*'
  cache:
    paths:
      - frontend/node_modules/**/*
      - frontend/.next/cache/**/*
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Strict-Transport-Security'
          value: 'max-age=31536000; includeSubDomains'
        - key: 'X-Frame-Options'
          value: 'SAMEORIGIN'
        - key: 'X-XSS-Protection'
          value: '1; mode=block' 